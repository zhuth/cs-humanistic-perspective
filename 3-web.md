> 说明：为正常显示本文中的数学公式，请使用 Chrome 浏览器并安装 [GitHub with MathJax](https://chrome.google.com/webstore/detail/github-with-mathjax/ioemnmodlmafdkllaclgeombjnmnbima/related) 插件。

# 网络、数据库与网站架设

- Flask
	- 网络基本知识
	- HTML
	- CSS/JavaScript 基础
- MySQL
- Django 介绍

## 第一讲 第一个网页

这个系列的目的在于使用基于 Python 的 Flask 框架制作一个自己的网站。在开始之前，我们首先需要确立的自己的目的。你是为了什么而要做一个网站呢，它与已有的那些网站有什么不同？这些理由可能是：

- 豆瓣不好用，我想自己做一个。
- 我想建立一个自己风格独特的个人网站。
- 我在创业，需要一个网站来宣传自己。
- ……

以上理由中，有一些是很好的理由，有一些不是很好的理由。比如，想做豆瓣的那位同学，请问你是怎么理解豆瓣的呢？如果你只是想建立一个自己整理书影音收藏的目录，那么你的工作量依然是可控的；但是如果你想做一个像豆瓣那样公开的、面向大众参与互动的网站，那么恐怕这件事情的复杂程度远远超过了你的想象。而如果你想做一个自己独特风格的个人网站、一个创业公司的宣传页面，你可能更需要的是学习如何设计网页的外观，将它们运用到现成的各种框架中，如 WordPress。总之，这些都不需要你学习 Python 才能够做；但是，如果你觉得学习 WordPress 的难度甚至高于自己做一个，而你的设计将极为简洁明快，那么，也许你可以尝试一下。

### 学习 Python 能帮你做什么？

网站的“后端”：通俗来说，就是那看不见的部分。它解决“什么页面显示什么内容”的问题。因此它最适合的场景并不是上面这些，而是：

- 为我所在的公司制作一个内部抢月饼的网站
	- <s>趁机可以让老板开除掉一些安全部门的同事</s>
- 评奖申报、活动报名
- 成绩填表整理和产生
- 常用格式文本
- ……

等有特定格式要求和限制的场景。在这些场景中，许多情况缺乏通用的解决方案，或那些方案相对于实际要完成的工作显得过于臃肿而难以理解。在这种情况下，你可以考虑做一个网站，使用 Python 所提供的强大功能。否则，恐怕 WordPress 和各种 CMS 可能更适合你。

### 环境配置

本教程将在很大程度上讲述 Flask 框架的使用。因此，我们有必要首先安装 Flask 包。回忆 [第一部分](1-python.md) 中的相关章节，我们记得，要安装 Flask 可以在命令行中执行下面的命令：

```shell
pip install flask
```

在一段时间的等待之后，Flask 应该安装完毕了。这时我们在 Python 中输入

```python
import flask
```

就不应该报任何错误了。


### 第一个页面！

```python
#coding: utf-8
from flask import Flask

app = Flask(__name__)

@app.route('/')
def index():
    return 'My first page!'

if __name__ == '__main__':
    app.debug = True
    app.run()
```

尝试运行这个程序，它并不像之前我们所遇到的那些一样会马上退出。屏幕上会显示：


```
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
 * Restarting with stat
 * Debugger is active!
 * Debugger pin code: 275-951-055
```

其中，`275-951-055` 这串数字会有所不同。这表明，程序已经开始运行了。

我们在浏览器中打开 http://127.0.0.1:5000/ ，可以看到里面显示了：

```
My first page!
```

这行文字，而这正是我们在 `index` 函数中返回的字符串。

**练习**

用你喜欢的一句话替代这里面的 `My first page!` 这句话。

#### 出现了错误怎么办

有时我们会遇到

```
socket.error: [Errno 48] Address already in use
```

这时，说明我们之前已经运行了一个网站的脚本而没有退出。找到它，将它关闭，然后再尝试一下。

### 发生了什么

我们来一行行看上面这个代码。

```python
#coding: utf-8 <- 这行告诉 Python 解释器用 UTF-8 编码来看待这个文件
from flask import Flask # 从 flask 包中引入 Flask 这个类

app = Flask(__name__) # app 是 Flask 这个类的一个实例。 __name__ 表明当前模块的名称

@app.route('/') # 这是一个装饰器。它告诉 app 也就是我们的网站，下面这个函数，用来处理路径为 '/' 的请求（request）
def index(): # 定义一个叫 index 的函数
    return 'My first page!' # 返回 'My first page!' 这个字符串

if __name__ == '__main__': # 如果我们是在直接运行这个文件
    app.debug = True # 打开调试（debug）模式
    app.run() # 开始运行测试服务器
```

这个解释引出了更多的问题。

- 上面的错误中的 `Address` 指的是什么？
- “路径为 '/' 的请求”一句中的“路径”和“请求”是什么？我那么要强，可从来不求人的啊。

而要说明这些，我们就势必要理解，当我们在浏览器中输入 `http://127.0.0.1:5000/` 并回车（或仅仅只是点击了这个链接时）发生了什么。

就像我们在打电话时需要拨号一样，浏览器需要首先找到服务器“在哪里”。打电话需要一个电话号码，而要找到服务器也需要知道它的网络地址（IP 地址）。电话拨通之后，我们需要语言和对方沟通，比如一个河南人和一个广东人打电话，就没办法讲各自的方言，而要讲他们都学习过的普通话（甚至有时候不得不讲英语）。这种说的话的约定，在浏览器和服务器的通信之中称为**协议**。协议的规定完全是人为的，只需要双方都遵守即可。然后，在这种协议的前提下，双方开始交换信息，比如浏览器告诉服务器“要什么网页”，而服务器告诉浏览器“有没有这个网页”和“这个网页的内容是什么”。如何与服务器通信、服务器的地址，以及我们所需要的是哪个网页，都由 `http://127.0.0.1:5000/` 这串字符确定。习惯上，我们把浏览器发出的信息称为**请求**，而将服务器返回的称为**响应**（response）。

#### HTTP 协议

我们首先来看开头的这个 `http`。`://` 可以看做一个分隔符号。它之前的内容表示了所采用的协议。HTTP 协议是浏览网站时的常用协议，另一种常用的协议则是 HTTPS。

#### IP 地址

`127.0.0.1` 是一个 IP 地址，而且是一个特殊的 IP 地址，它指的就是“本机”。同样，安装配置无线路由器之类的时候，说明书要求输入的 `192.168.1.1` 之类也都是 IP 地址，这种地址用来表示局域网内（比如在无线路由器的例子里，就是连入同一个无线网络）的 IP 地址。学校、公司常用 `10.*.*.*` 这样的 IP 地址，道理也是相同。只有除了这三类以外的 IP 地址，才可能是一个互联网上的 IP 地址。比如，`115.182.201.8` 是豆瓣的一个服务器的 IP 地址。

#### 域名

正如我们打电话的时候可以用通讯录来保存电话号码以避免记忆，我们也用域名来代替 IP 地址。这时，浏览器就额外增加了一个步骤，它与域名解析服务器（DNS）先进行沟通，查询域名对应的 IP 地址，然后再根据查询的结果来向这个 IP 地址的服务器正式进行沟通。要了解域名对应的 IP 地址，可以使用命令行的 `ping` 和 `nslookup` 命令。这两个命令在 Windows 和 Linux/macOS 上都存在。同样，有一个特殊的“域名”叫做 `localhost`，它一定会被解析为 `127.0.0.1`，也就是指向本机。

#### 端口号

`5000` 引入了一个称为**端口号**的概念。引入端口是出于这样的原因：一台服务器，或者一台电脑上，可能运行了许多个网络程序。这样，单单告诉“信息要发给某个地址的服务器”就显得不够了，还要表明这个信息应该让服务器上的哪个程序来处理。端口号就起到这样的作用。对于 HTTP 协议而言，默认的端口号是 80，所以我们访问豆瓣时使用 `http://www.douban.com/` 即可而没有出现这个端口号。实际上，如果我们强行输入 `http://www.douban.com:80/` 也是可以的。对于 HTTPS 协议而言，默认的端口号是 443 。这里的两个数字是由一份称为 [RFC 6335](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml) 的文件规定的。IP 地址/域名，和可选的端口号，共同组成了一个“主机名”。比如在我们的例子中，`127.0.0.1:5000` 就是一个主机名。

#### 路径

最后我们看到还有一个孤零零的 `/`。这也就是我们在前面的注释中所看到的那个“路径”。

#### 一点点修改

现在我们再在上面的代码 `index()` 函数定义的下面增加如下代码：

```python
@app.route('/abc')
def abc():
	return 'You requested abc'
```

这时，如果你前面没有退出测试服务器，应该会看到屏幕上又多了两行：

```
 * Detected change in '/Works/cs-humanistic-perspective/web-test.py', reloading
 * Restarting with stat
 * Debugger is active!
 * Debugger pin code: 275-951-055
```

我们这时访问 `http://localhost:5000/abc`，不出所料，浏览器上显示了：

```
You requested abc
```

而我们再将 `abc` 这一段改成如下的样子：

```python
@app.route('/<name>')
def abc(name):
	return 'You requested ' + name
```

在浏览器访问 `http://localhost:5000/test`，浏览器上显示：

```
You requested test
```

这样，我们就知道，不同的路径可以通过不同的函数来进行处理，而多个路径也可以通过参数来由同一个函数处理。

### 让网页复杂一些

现在，我们不满足输出一个简单的字串了。下载本项目中的 [dao.py](dao.py) 和 [pyhtml.py](pyhtml.py) ，我们将利用它们引入对数据库和 HTML 的介绍。

将 `index` 函数改写成下面的样子：

```python
def index():
	return str(
    	HTML(
			HEAD(TITLE("test")),
			BODY(
				[P(
					"Paragraph %d" % i
				) for i in range(5)],
				DIV('div element'),
				COMMENT("Some other text"),
				A("index", href="/"),
				IMG(src="https://help.github.com/assets/images/site/be-social.gif")
				)
			)
    	)
```

并且别忘了在一开始增加 

```python
from pyhtml import *
```

打开浏览器访问 `http://localhost:5000/`，应该看到下图：

![Screenshot](images/screenshot-1.png)

`pyhtml` 是这一部分中为说明 HTML 而写的一个辅助模块。我们在 Chrome 中打开现在的网页，右键点击空白处选择“检查”（Inspect），确保选中了“Elements”选项卡，会看到下图：

![Screenshot](images/screenshot-1-chrome-inspect.png)

这其中所有的内容称之为“网页源代码”，它是用另外一种不同于 Python 的语言，称之为 HTML 语言，写成的。但我们用 `pyhtml` 这个模块，而运用 Python 将它产生了出来。我们把它和上面的这些代码相比较，发现它们同样都有层级的结构，从而构成了我们在[第二部分](2-algo.md)中所说的“树”这种数据结构。每一个 `<>` 括起的都称为一个**标签**。有的标签需要一个和它相对应的闭合标签（`< ... >` 对应于 `</ ... >`），而其中包含了它的子标签（节点）；有的则不需要。但所有这些从根本上仍然只是字符串而已。 有的标签有属性，比如 `a` 标签有一个 `href` 的属性，它的意思是表明这个链接指向何处；比如 `img` 标签有一个 `src` ，表明了要插入的图像的网址。

**练习**

1. 探索 Chrome 的“检查”功能，更改 `index` 函数返回的 HTML 代码，观察它会造成什么结果。
2. 打开你最喜欢的一个网站的首页，使用“检查”功能，依次找到不同内容对应的标签。提示：你可以通过右键点击该节点，选择“Edit as HTML”，来更改它里面的内容。
3. 配合该网页显示的样式，理解若干 HTML 标签的功能和用法，特别是 `a`、`img`、`br`、`b`、`i`、`table`。尝试用 `pyhtml` 来产生类似的结构。
4. *进阶* 查看 `pyhtml.py`，修改它以增加对新的标签的支持。
